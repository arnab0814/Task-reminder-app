<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Task List</title>
   <link rel="stylesheet" th:href="@{/task.css}">
</head>
<body>

<h1>All Tasks</h1>


<div th:if="${successMessage}">
    <p th:text="${successMessage}" style="color: green;"></p>
</div>
<div th:if="${errorMessage}">
    <p th:text="${errorMessage}" style="color: red;"></p>
</div>


<form th:action="@{/tasks/list}" method="get" style="margin-bottom:16px;">
    <label for="status">Status:</label>
    <select id="status" name="status">
        <option value="" th:selected="${filterStatus == null}">-- Any --</option>

        <option th:each="s : ${T(com.taskmanager.app.entity.TaskEntity$Status).values()}"
                th:value="${s.name()}"
                th:text="${s.name()}"
                th:selected="${filterStatus != null and filterStatus.name() == s.name()}">
        </option>
    </select>

    <label for="priority" style="margin-left:12px;">Priority:</label>
    <select id="priority" name="priority">
        <option value="" th:selected="${filterPriority == null or filterPriority == ''}">-- Any --</option>
        <option value="HIGH" th:selected="${filterPriority == 'HIGH'}">HIGH</option>
        <option value="MEDIUM" th:selected="${filterPriority == 'MEDIUM'}">MEDIUM</option>
        <option value="LOW" th:selected="${filterPriority == 'LOW'}">LOW</option>
    </select>

    <label for="title" style="margin-left:12px;">Title:</label>
    <input type="text" id="title" name="title" th:value="${filterTitle}" placeholder="Search title..."/>

    <input type="hidden" name="sortField" th:value="${sortField}"/>
    <input type="hidden" name="sortDir" th:value="${sortDir}"/>
    <input type="hidden" name="size" th:value="${pageSize}"/>

    <button type="submit" style="margin-left:8px;">Filter</button>
    <a href="/tasks/list" style="margin-left:8px;">
        <button type="button">Clear Filters</button>
    </a>
</form>

<table>
    <thead th:with="
        toggleIdDir=${sortField == 'id' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'},
        toggleNameDir=${sortField == 'name' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'},
        togglePriorityDir=${sortField == 'priority' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'},
        toggleStatusDir=${sortField == 'status' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'},
        toggleDueDateDir=${sortField == 'dueDate' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'}">

    <tr>
        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='id', sortDir=${toggleIdDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                ID <span th:if="${sortField=='id'}" th:text="${sortDir == 'ASC' ? '▲' : '▼'}"></span>
            </a>
        </th>

        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='name', sortDir=${toggleNameDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                Task Name <span th:if="${sortField=='name'}" th:text="${sortDir == 'ASC' ? '▲' : '▼'}"></span>
            </a>
        </th>

        <th>Description</th>

        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='priority', sortDir=${togglePriorityDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                Priority <span th:if="${sortField=='priority'}" th:text="${sortDir == 'ASC' ? '▲' : '▼'}"></span>
            </a>
        </th>

        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='status', sortDir=${toggleStatusDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                Status <span th:if="${sortField=='status'}" th:text="${sortDir == 'ASC' ? '▲' : '▼'}"></span>
            </a>
        </th>

        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='dueDate', sortDir=${toggleDueDateDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                Due Date <span th:if="${sortField=='dueDate'}" th:text="${sortDir == 'ASC' ? '▲' : '▼'}"></span>
            </a>
        </th>

        <th>Created On</th>
        <th>Completed At</th>
        <th>Actions</th>
    </tr>
    </thead>

    <tbody>
    <tr th:each="task : ${taskPage.content}" th:classappend="${task.status.name() == 'DONE'} ? 'done-row' : ''">
        <td th:text="${task.id}">1</td>

        <td>
    <span th:if="${task.status != null and task.status.name() == 'DONE'}"
          class="strike"
          th:text="${task.name}">
    </span>

            <span th:if="${task.status == null or task.status.name() != 'DONE'}"
                  th:text="${task.name}">
    </span>
        </td>


        <td th:text="${task.description}">Description</td>
        <td th:text="${#strings.capitalize(#strings.toLowerCase(task.priority))}"></td>

        <td>
            <span th:if="${task.status != null and task.status.name() == 'DONE'}" class="badge-done">DONE</span>
            <span th:if="${task.status != null and task.status.name() == 'IN_PROGRESS'}" class="badge-in_progress">IN_PROGRESS</span>
            <span th:if="${task.status == null or task.status.name() == 'PENDING'}" class="badge-pending">PENDING</span>
        </td>

        <td th:text="${task.dueDate != null ? #temporals.format(task.dueDate,'dd-MM-yyyy') : 'N/A'}">N/A</td>

        <td th:text="${task.createdAt != null ? #temporals.format(task.createdAt,'dd-MM-yyyy HH:mm') : 'N/A'}">N/A</td>

        <td>
        <span th:if="${task.completedAt != null}"
              th:text="${#temporals.format(task.completedAt,'dd-MM-yyyy HH:mm')}">
        </span>
                <span th:if="${task.completedAt == null}">—</span>
        </td>



        <td class="actions">
            <a th:href="@{/tasks/view/{id}(id=${task.id})}">View</a> |

            <span th:if="${task.status.name() != 'DONE'}">
        <a th:href="@{/tasks/edit/{id}(id=${task.id})}">Edit</a> |
    </span>

            <a th:href="@{/tasks/delete/{id}(id=${task.id})}"
               onclick="return confirm('Are you sure you want to delete this task?');">
                Delete
            </a>

            <span th:if="${task.status.name() != 'DONE'}">
        &nbsp;|&nbsp;
        <a th:href="@{/tasks/done/{id}(id=${task.id})}"
           onclick="return confirm('Mark this task as done?');">
           Mark Done
        </a>
    </span>
        </td>
    </tr>

    <tr th:if="${#lists.isEmpty(taskPage.content)}">
        <td colspan="8">No tasks found.</td>
    </tr>
    </tbody>
</table>

<div class="pager" th:if="${totalPages > 1}" style="margin-top:12px;">
    <span>Page [[${currentPage + 1}]] of [[${totalPages}]]</span>
    <br/><br/>

    <a th:if="${!taskPage.first}" th:href="@{/tasks/list(page=0, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">&laquo; First</a>

    <a th:if="${taskPage.hasPrevious()}" th:href="@{/tasks/list(page=${currentPage - 1}, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">&lt; Prev</a>

    <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
        <a th:if="${i != currentPage}" th:href="@{/tasks/list(page=${i}, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}" th:text="${i + 1}">1</a>
        <span th:if="${i == currentPage}" th:text="${i + 1}" style="font-weight:bold; text-decoration:underline;"></span>
    </span>

    <a th:if="${taskPage.hasNext()}" th:href="@{/tasks/list(page=${currentPage + 1}, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">Next &gt;</a>

    <a th:if="${!taskPage.last}" th:href="@{/tasks/list(page=${totalPages - 1}, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">Last &raquo;</a>
</div>

<p style="margin-top:16px;">
    <a th:href="@{/tasks/new}">
        <button type="button">Add New Task </button>
    </a>
</p>

</body>
</html>
