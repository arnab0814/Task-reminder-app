<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Task List</title>
   <link rel="stylesheet" th:href="@{/task.css}">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

</head>
<body>

<div class="header">
    <h1>Task Manager</h1>
    <div class="top-actions">
    <button class="btn btn-outline" onclick="toggleView()">
        üóÇ Card View
    </button>
    <button onclick="openCalendar()" class="btn-calendar">
        üóì Calendar
    </button>
    </div>
</div>
<div id="cardView" class="card-container">

    <div class="task-card"
         th:each="task : ${taskPage.content}"
         onclick="openTaskFromCalendar(${t.id})"
         th:classappend="${task.status.name() == 'DONE'} ? 'done' : ''">

        <div>
            <div class="task-title" th:text="${task.name}">Task</div>

            <div class="task-desc" th:text="${task.description}"></div>

            <div class="meta">
                Priority:
                <b th:text="${#strings.capitalize(#strings.toLowerCase(task.priority))}"></b><br/>
                Due:
                <span th:text="${task.dueDate != null ? #temporals.format(task.dueDate,'dd MMM yyyy') : 'N/A'}"></span>
            </div>

            <span class="badge"
                  th:classappend="${task.status.name() == 'DONE'} ? 'done' : 'pending'"
                  th:text="${task.status.name()}">
            </span>
        </div>

        <div class="card-actions">
            <a th:href="@{/tasks/view/{id}(id=${task.id})}">View</a>

            <span th:if="${task.status.name() != 'DONE'}">
                <a th:href="@{/tasks/edit/{id}(id=${task.id})}">Edit</a>
                <a th:href="@{/tasks/done/{id}(id=${task.id})}">Done</a>
            </span>
        </div>
    </div>
</div>

<div id="calendarModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeCalendar()">&times;</span>
        <h2>Task Calendar</h2>
        <div id="calendar" ></div>
    </div>
</div>

<div id="taskPopup" class="modal" >
    <div class="modal-content">
        <span class="close" onclick="closeTaskPopup()">&times;</span>
        <h3 id="popupDate"></h3>
        <div id="popupTasks" class="card-container"></div>
    </div>
</div>


<div th:if="${successMessage}">
    <p th:text="${successMessage}" style="color: green;"></p>
</div>
<div th:if="${errorMessage}">
    <p th:text="${errorMessage}" style="color: red;"></p>
</div>


<form th:action="@{/tasks/list}" method="get" style="margin-bottom:16px;">
    <label for="status">Status:</label>
    <select id="status" name="status">
        <option value="" th:selected="${filterStatus == null}">-- Any --</option>

        <option th:each="s : ${T(com.taskmanager.app.entity.TaskEntity$Status).values()}"
                th:value="${s.name()}"
                th:text="${s.name()}"
                th:selected="${filterStatus != null and filterStatus.name() == s.name()}">
        </option>
    </select>

    <label for="priority" style="margin-left:12px;">Priority:</label>
    <select id="priority" name="priority">
        <option value="" th:selected="${filterPriority == null or filterPriority == ''}">-- Any --</option>
        <option value="HIGH" th:selected="${filterPriority == 'HIGH'}">HIGH</option>
        <option value="MEDIUM" th:selected="${filterPriority == 'MEDIUM'}">MEDIUM</option>
        <option value="LOW" th:selected="${filterPriority == 'LOW'}">LOW</option>
    </select>

    <label for="title" style="margin-left:12px;">Title:</label>
    <input type="text" id="title" name="title" th:value="${filterTitle}" placeholder="Search title..."/>

    <input type="hidden" name="sortField" th:value="${sortField}"/>
    <input type="hidden" name="sortDir" th:value="${sortDir}"/>
    <input type="hidden" name="size" th:value="${pageSize}"/>

    <button type="submit" style="margin-left:8px;">Filter</button>
    <a href="/tasks/list" class="clrfilter" style="margin-left:8px;">
        <button type="button">Clear Filters</button>
    </a>
    <a th:href="@{/tasks/new}" class="addNew" style="margin-top:14px;">
            <button type="button">Add New Task</button>
    </a>
</form>

<div class="table-wrapper">
<table>

    <thead th:with="
        toggleIdDir=${sortField == 'id' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'},
        toggleNameDir=${sortField == 'name' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'},
        togglePriorityDir=${sortField == 'priority' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'},
        toggleStatusDir=${sortField == 'status' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'},
        toggleDueDateDir=${sortField == 'dueDate' ? (sortDir == 'ASC' ? 'DESC' : 'ASC') : 'ASC'}">

    <tr>
        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='id', sortDir=${toggleIdDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                ID <span th:if="${sortField=='id'}" th:text="${sortDir == 'ASC' ? '‚ñ≤' : '‚ñº'}"></span>
            </a>
        </th>

        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='name', sortDir=${toggleNameDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                Task Name <span th:if="${sortField=='name'}" th:text="${sortDir == 'ASC' ? '‚ñ≤' : '‚ñº'}"></span>
            </a>
        </th>

        <th>Description</th>

        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='priority', sortDir=${togglePriorityDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                Priority <span th:if="${sortField=='priority'}" th:text="${sortDir == 'ASC' ? '‚ñ≤' : '‚ñº'}"></span>
            </a>
        </th>

        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='status', sortDir=${toggleStatusDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                Status <span th:if="${sortField=='status'}" th:text="${sortDir == 'ASC' ? '‚ñ≤' : '‚ñº'}"></span>
            </a>
        </th>

        <th>
            <a th:href="@{/tasks/list(page=0, size=${pageSize}, sortField='dueDate', sortDir=${toggleDueDateDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">
                Due Date <span th:if="${sortField=='dueDate'}" th:text="${sortDir == 'ASC' ? '‚ñ≤' : '‚ñº'}"></span>
            </a>
        </th>

        <th>Created On</th>
        <th>Completed At</th>
        <th>Actions</th>
    </tr>
    </thead>

    <tbody>
    <tr th:each="task : ${taskPage.content}" th:classappend="${task.status.name() == 'DONE'} ? 'done-row' : ''">
        <td th:text="${task.id}">1</td>

        <td>
    <span th:if="${task.status != null and task.status.name() == 'DONE'}"
          class="strike"
          th:text="${task.name}">
    </span>

            <span th:if="${task.status == null or task.status.name() != 'DONE'}"
                  th:text="${task.name}">
    </span>
        </td>


        <td th:text="${task.description}">Description</td>
        <td th:class="'priority-' + ${#strings.toLowerCase(task.priority)}"
            th:text="${#strings.capitalize(#strings.toLowerCase(task.priority))}">
        </td>



        <td>
            <span th:if="${task.status != null and task.status.name() == 'DONE'}" class="badge-done">DONE</span>
            <span th:if="${task.status != null and task.status.name() == 'IN_PROGRESS'}" class="badge-in_progress">IN_PROGRESS</span>
            <span th:if="${task.status == null or task.status.name() == 'PENDING'}" class="badge-pending">PENDING</span>
        </td>

        <td th:text="${task.dueDate != null ? #temporals.format(task.dueDate,'dd-MM-yyyy') : 'N/A'}">N/A</td>

        <td th:text="${task.createdAt != null ? #temporals.format(task.createdAt,'dd-MM-yyyy HH:mm') : 'N/A'}">N/A</td>

        <td>
        <span th:if="${task.completedAt != null}"
              th:text="${#temporals.format(task.completedAt,'dd-MM-yyyy HH:mm')}">
        </span>
                <span th:if="${task.completedAt == null}">‚Äî</span>
        </td>



        <td class="actions">
            <a th:href="@{/tasks/view/{id}(id=${task.id})}" title="View">
                üëÅ View
            </a>

            <span th:if="${task.status.name() != 'DONE'}">
        <a th:href="@{/tasks/edit/{id}(id=${task.id})}" title="Edit">
            ‚úè Edit
        </a>
    </span>

            <span th:if="${task.status.name() != 'DONE'}">
        <a th:href="@{/tasks/done/{id}(id=${task.id})}"
           onclick="return confirm('Mark this task as done?');"
           title="Mark Done">
            ‚úÖ Done
        </a>
    </span>

            <a th:href="@{/tasks/delete/{id}(id=${task.id})}"
               onclick="return confirm('Delete this task?');"
               title="Delete"
               class="danger">
                üóë Delete
            </a>
        </td>

    </tr>

    <tr th:if="${#lists.isEmpty(taskPage.content)}">
        <td colspan="8">No tasks found.</td>
    </tr>
    </tbody>
</table>
</div>
<script>
    function toggleView() {
        const cardView = document.getElementById("cardView");
        const table = document.querySelector("table");
        const toggleBtn = document.querySelector(".header button");

        if (!cardView || !table || !toggleBtn) {
            console.error("Toggle elements missing");
            return;
        }

        const cardVisible = cardView.style.display === "grid";

        if (cardVisible) {
            cardView.style.display = "none";
            table.style.display = "table";
            toggleBtn.textContent = "üóÇ Card View";
        } else {
            cardView.style.display = "grid";
            table.style.display = "none";
            toggleBtn.textContent = "üìã List View";
        }
    }
let calendar = null;

function openCalendar() {
    const modal = document.getElementById("calendarModal");
    modal.style.display = "block";

    // First-time init
    if (!calendar) {
        initCalendar();
    }

    setTimeout(() => {
        calendar.updateSize();
    }, 50);
}


function closeCalendar() {
    document.getElementById("calendarModal").style.display = "none";
}

function closeTaskPopup() {
    document.getElementById("taskPopup").style.display = "none";
}

function initCalendar() {
    console.log("Initializing calendar...");

    const calendarEl = document.getElementById("calendar");
    if (!calendarEl) {
        console.error("Calendar element not found");
        return;
    }

    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: 600,
        selectable: true,
        fixedWeekCount: false,

        events: "/api/tasks/calendar",

        eventClick: function (info) {
            info.jsEvent.preventDefault();
            openTaskFromCalendar(info.event.id);
        },

        dateClick: function (info) {
            console.log("Date clicked:", info.dateStr);
            loadTasksByDate(info.dateStr);
        }
    });

    calendar.render();
}

function openTaskFromCalendar(taskId) {
    fetch(`/api/tasks/${taskId}`)
        .then(res => res.json())
        .then(task => {
            document.getElementById("popupDate").innerText = task.name;

            const container = document.getElementById("popupTasks");
            container.innerHTML = `
                <div class="task-card">
                    <div class="task-title">${task.name}</div>
                    <div class="task-desc">${task.description || ""}</div>

                    <div class="meta">
                        Priority: <b>${task.priority}</b><br/>
                        Status: <b>${task.status}</b><br/>
                        Due: ${task.dueDate || "N/A"}
                    </div>

                    <span class="badge ${task.status === "DONE" ? "done" : "pending"}">
                        ${task.status}
                    </span>
                </div>
            `;

            document.getElementById("taskPopup").style.display = "block";
        })
        .catch(err => console.error("Task load error", err));
}

function loadTasksByDate(date) {
    fetch(`/api/tasks/by-date?date=${date}`)
        .then(res => res.json())
        .then(tasks => {
            const popup = document.getElementById("taskPopup");
            const container = document.getElementById("popupTasks");

            document.getElementById("popupDate").innerText =
                "Tasks on " + date;

            container.innerHTML = "";

            if (!tasks.length) {
                container.innerHTML = "<p>No tasks found.</p>";
                popup.style.display = "block";
                return;
            }

            tasks.forEach(t => {
                container.innerHTML += `
                    <div class="task-card">
                        <div class="task-title">${t.name}</div>

                        <div class="task-desc">
                            ${t.description || "No description"}
                        </div>

                        <div class="meta">
                            <b>Priority:</b> ${t.priority}<br/>
                            <b>Status:</b> ${t.status}<br/>
                            <b>Due:</b> ${t.dueDate || "N/A"}
                        </div>

                        <span class="badge ${t.status === "DONE" ? "done" : "pending"}">
                            ${t.status}
                        </span>
                    </div>
                `;
            });

            popup.style.display = "block";
        })
        .catch(err => console.error(err));
}



</script>




<div class="pager" th:if="${totalPages > 1}" style="margin-top:12px;">
    <span>Page [[${currentPage + 1}]] of [[${totalPages}]]</span>
    <br/><br/>

    <a th:if="${!taskPage.first}" th:href="@{/tasks/list(page=0, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">&laquo; First</a>

    <a th:if="${taskPage.hasPrevious()}" th:href="@{/tasks/list(page=${currentPage - 1}, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">&lt; Prev</a>

    <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
        <a th:if="${i != currentPage}" th:href="@{/tasks/list(page=${i}, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}" th:text="${i + 1}">1</a>
        <span th:if="${i == currentPage}" th:text="${i + 1}" style="font-weight:bold; text-decoration:underline;"></span>
    </span>

    <a th:if="${taskPage.hasNext()}" th:href="@{/tasks/list(page=${currentPage + 1}, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">Next &gt;</a>

    <a th:if="${!taskPage.last}" th:href="@{/tasks/list(page=${totalPages - 1}, size=${pageSize}, sortField=${sortField}, sortDir=${sortDir}, status=${filterStatus != null ? filterStatus.name() : ''}, priority=${filterPriority}, title=${filterTitle})}">Last &raquo;</a>
</div>

</body>
</html>
